<html>
<head>
  <title>PlantNation</title>
  <meta name=viewport content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
  <!-- Slick slider for onboarding -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>

  <link href="/stylesheets/style.css" rel="stylesheet">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.dev.js" ></script>
</head>
<body>
  <div class="page status">
  <header>
    <span><img src="/images/ruuts.svg" /> | PlantStatus</span>
  <a href="menu"><span class="fas fa-bars"></span></a>
</header>
  <div class="content">
    <div id="shield">
      <div id="modal" class="hidden">
        <div class="close fas fa-times-circle"></div>
        <div class="message">
        </div>
      </div>
    </div>

   <div class="content-header">
     <a class="btn">MANUAL MODE</a>
   </div>
<div class="content-content">
  <div id="lightfade" class=""></div>
  <div class="bars bar1 hidden"></div>
    <div class="bars bar2 hidden"></div>
    <div class="bars bar3 hidden"></div>
    <div class="bars bar4 hidden"></div>
  <div class="plant">
    <svg id="plant" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
   viewBox="0 0 1024 1024">
<rect id="trunk" x="496" y="423.7" class="st0" width="32" height="280"/>
<path id="head" class="st0" d="M512,88.2c-110.5,0-200,89.5-200,200s89.5,200,200,200c110.5,0,200-89.5,200-200S622.5,88.2,512,88.2
  z M512,352.2c-35.3,0-64-28.7-64-64s28.7-64,64-64c35.3,0,64,28.7,64,64S547.3,352.2,512,352.2z"/>
<polygon id="roots" class="st0" points="649,699.8 512,935.8 375,699.8 "/>
</svg>

  </div>
  </div>
  <div class="content-footer">
    <a id="connect" class="btn" href="#"><span id="connect-icon" class="fas fa-toggle-off"></span></a>
    <a id="water-on" class="btn" href="#"><span class="fas fa-tint"></span></a>
    <a id="light" class="btn" href="#"><span class="fas fa-sun"></span></a>
  </div>
  </div>
  <footer>
      <a href="recipes.html">Recipes</a>
      <a href="index.html" class="active">Garden</a>
      <a href="info.html">Info</a>
  </footer>
  </div>

<div id="skip">skip</div>
  <div class="onboarding">
    <div><h3>Welcome to PlantIO</h3><p>Grow food, automatically.</p></div>
    <div>
      <h3>Choose seed</h3>
      <p>First you need to pick a seed to grow. Here, try this free starting seed we found in our lab...</p>
      <input type="radio"><label class="mysterious">&hellip;unknown seed&hellip;</label>
    </div>
    <div>
      <h3>Choose recipe</h3>
      <p>Now you need to decide what kind of harvest you want. There are many different ways to grow a single plant, you can focus on size, yield, tase, all sorts.</p>
      <p>Erm, unfortunately we only have one recipe for this <span class="mysterious">unknown seed</span>, we found it on a scrap of paper on the floor of our lab&hellip;</p>
      <input type="radio"><label class="mysterious">&hellip;scrappy recipe&hellip;</label>
    </div>
    <div>
      <h3>Connect to your PlantIO system</h3>
      <p>Nearly there! Just connect to your PlantIO system and&hellip;oh, you don't have one yet.</p>
      <p>Not to worry, you can connect to our <span class="mysterious">cloud system</span> for now.</p>
      <button id="tatty-old-recipe">Connect to CloudPlantIO</button>
    </div>
    <div>
      <h3>Plant your seed</h3>
      <p>Now it's time to place your seed inside your PlantIO system, and wait for it to begin sprouting.</p>
      <p>Your <span class="mysterious">unknown seed</span> just vanished. It must have teleported into the CloudPlantIO. Wait, why is that clock going round so fast&hellip;</p>
      <button>Setup complete!</button>
    </div>

  </div>


  <!-- START  SCRIPTS-->
   <script>

   /* TODO: Read up on: */
   // http://markdalgleish.com/2011/03/self-executing-anonymous-functions/

(function(window, document, undefined){


  let socketOpen = false;
  let socket = null;
  let port = ':3000';



  function connectPlantIO() {


  return new Promise(function(resolve, reject) {

      console.log('connecting to CloudPlantIO...')
      document.getElementById('shield').classList.toggle('hidden')

      //get internal ip automatically:
      //https://stackoverflow.com/questions/32837471/how-to-get-local-internal-ip-with-javascript

      window.RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;   //compatibility for firefox and chrome
      var pc = new RTCPeerConnection({iceServers:[]}), noop = function(){};
      pc.createDataChannel("");    //create a bogus data channel
      pc.createOffer(pc.setLocalDescription.bind(pc), noop);    // create offer and set local description
      pc.onicecandidate = function(ice){  //listen for candidate events

          if(!ice || !ice.candidate || !ice.candidate.candidate)  return;
          var myIP = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(ice.candidate.candidate)[1];
          //console.log('my IP: ', myIP);
          pc.onicecandidate = noop;

          let ip = myIP + port;
          socket = io(ip);
          socketOpen = true;
          console.log('Connected!');
          resolve({name: 'alcwyn', hobby: 'coding'});
      };



  });


}

/*
 if ( socketOpen === true ) {
   console.log('disconnecting...')
   document.getElementById('shield').classList.toggle('hidden')
   connectIcon.classList.replace("fa-toggle-on", "fa-toggle-off")
   socket = null;
   socketOpen = false;
 }
else {

}
*/

//Recipe constructor
function Recipe(name, duration, light, feed, temperature) {
  this.name = name;
  this.duration = duration; // days
  this.light = light; //milliseconds [TODO: convert to seconds]
  this.feed = feed; // milliseconds [TODO: convert to seconds]
  this.temperature = temperature;
}

//Recipe objects
var filsToms = new Recipe('filsToms', 30, 5000, 1000, 20);
var disco = new Recipe('disco', 30, 500, 500, 30);
var temp = new Recipe('disco', 30, 10000, 10000, 10);

function daysToMilliseconds (days) {
  ms = days * 24 * 60 * 60 * 1000
  return ms
}

    // Generic controller

    let power = false;
    let ambient = 0;

    function controller(element){
      if (power === false){
        console.log('turning on ' + element)
        socket.emit('hardware', {type: element + '-on', duration: 'UNKNOWN' });
        toggleLightBars();
        power = true;
        console.log(power);
      }
      else if (power === true){
        console.log('turning off ' + element)
        socket.emit('hardware', {type: element + '-off', duration: 'UNKNOWN'});
        toggleLightBars();
        power = false;
        console.log(power);
      }
    }

    //Start recipe
    function startRecipe(chosen){
      console.log('Starting: ' + Object.values(chosen)[0] + ', ' + Object.values(chosen)[1] + ', ' + Object.values(chosen)[2] + ', ' + Object.values(chosen)[3] + ', ' + Object.values(chosen)[4])
      startTime = new Date().getTime();
      startDate = new Date(startTime);
      durationLength = daysToMilliseconds(Object.values(chosen)[1]);
      finishTime = new Date(startTime + durationLength);
      console.log('Date started: ' + startDate)
      console.log('Duration: ' + Object.values(chosen)[1] + ' days')
      console.log('Expected harvest: ' + finishTime)
      console.log('Harvest info: ' + durationLength)

      //light
      let lightLoop = setTimeout(function tick() {
        controller(Object.keys(chosen)[2]);
        lightLoop = setTimeout(tick, Object.values(chosen)[2]);
      }, Object.values(chosen)[2]);

      //feed
      let feedLoop = setTimeout(function tick() {
        controller(Object.keys(chosen)[3]);
        feedLoop = setTimeout(tick, Object.values(chosen)[3]);
      }, Object.values(chosen)[3]);

      //temperature
      function thermostat(){
        target = Object.values(chosen)[4];

        if (ambient <= target){
          console.log('Ambient temperature: ' + ambient);
          console.log('Target temperature: ' + target);
          console.log('turning on thermostat')
          socket.emit('hardware', {type: 'thermostat-on', duration: 'UNKNOWN'});
          //update UI
          ambient++;
        }
        else {
          console.log('Ambient temperature: ' + ambient);
          console.log('Target temperature: ' + target);
          console.log('turning off thermostat')
          socket.emit('hardware', {type: 'thermostat-off', duration: 'UNKNOWN'});
          //update UI
          ambient--;
        }
      }

      let temperatureLoop = setInterval(thermostat, 1000);

    }

    // Tatty old recipe
    let tattyOldRecipeButton = document.getElementById('tatty-old-recipe');

    tattyOldRecipeButton.addEventListener('click', function(){

      connectPlantIO().then( (results, anotherval) => {
        startRecipe(temp);
      })

    });




// Basic arrow functions (more detail needed)
// function shout(volume, sentence){
//  console.log(sentence)
// }

// (volume, sentence) => { console.log(sentence) }



//1. connect to plant if not connected
/*
if(socketOpen){
console.log('starting recipe...');
//2. Light plant for 12 hours, every 12 hours

}
else { console.log('Socket closed :(')};
*/

/*
      if (this.classList.contains('active') == true){
        console.log('turning off')
        socket.emit('hardware', {type: 'water-off', duration: 0});
      }
      else{
        console.log('turning on LEDs...')
        socket.emit('hardware', {type: 'water-on', duration: 10});
      }
    this.classList.toggle('active');

    */


   })(window, document);



    // get the UI elements
    let connectButton = document.getElementById('connect');
    let connectIcon = document.getElementById('connect-icon');

    //connect to plant manually
    //connectButton.addEventListener('click', connectPlantio() );












    // water plant manually
    let waterOnButton = document.getElementById('water-on')

    waterOnButton.addEventListener('click', function(){
      if(connectButton.classList.contains('active') == false){
        let modalMessage = document.querySelector(".message");
        modalMessage.innerHTML = "plant not connected"
        modalWindow.classList.toggle('hidden')

      }
      if (this.classList.contains('active') == true){
        console.log('turning off')
        socket.emit('hardware', {type: 'water-off', duration: 0});
      }
      else{
        console.log('turning on')
        socket.emit('hardware', {type: 'water-on', duration: 10});
      }
    this.classList.toggle('active');
  });

    let lightButton = document.getElementById('light')
    let modalWindow = document.getElementById('modal')
    let modalClose = document.querySelector(".close");

    //close modal
    modalClose.onclick = function() {
      modalWindow.classList.toggle('hidden')
    }

    //light plant manually
    lightButton.onclick = function lightPlant() {
      if(connectButton.classList.contains('active') == false){
        let modalMessage = document.querySelector(".message");
        modalMessage.innerHTML = "plant not connected"
        modalWindow.classList.toggle('hidden')

      }
      if (this.classList.contains('active') == true){
        console.log('turning off')
        socket.emit('hardware', {type: 'light-off'});
      }
      else{
        console.log('turning on')
        socket.emit('hardware', {type: 'light-on'});
      }
    this.classList.toggle('active');
    document.getElementById('lightfade').classList.toggle('power');
    barlist = document.getElementsByClassName('bars');
    for (var i = 0; i < barlist.length; i++) {
      barlist[i].classList.toggle('hidden')
    }
}

// toggle light visuals
function toggleLightBars() {
  document.getElementById('lightfade').classList.toggle('power');
  barlist = document.getElementsByClassName('bars');
  for (var i = 0; i < barlist.length; i++) {
    barlist[i].classList.toggle('hidden')
  }
}




  </script>

<script type="text/javascript">
//onboarding
$(document).ready(function(){
$('.onboarding').slick({
dots: true,
arrows: false,
draggable: true,
mobileFirst: true,
infinite: false
});

let skipButton = document.getElementById('skip');
skipButton.addEventListener('click', function(){
  document.querySelector('.onboarding').style.display = 'none';
  skipButton.style.display = "none";
});

});
</script>
</body>
</html>
